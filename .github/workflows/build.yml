name: Build
on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Update apt
        run: yes | sudo apt-get update
      - name: Install rsync
        run: yes | sudo apt-get install rsync
      - name: Install wget
        run: yes | sudo apt-get install wget
      - name: Install ant
        run: >
          cd /tmp;
          wget https://dlcdn.apache.org//ant/binaries/apache-ant-1.10.14-bin.zip;
          unzip apache-ant-1.10.14-bin.zip
      - name: Install java
        run: >
          cd /tmp;
          wget https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.5%2B8/OpenJDK17U-jdk_x64_linux_hotspot_17.0.5_8.tar.gz;
          tar -xvf OpenJDK17U-jdk_x64_linux_hotspot_17.0.5_8.tar.gz;
      - name: Prepare env
        run: >
          cd /tmp;
          echo 'export ANT_HOME="/tmp/apache-ant-1.10.14"' >> .bash_profile;
          echo 'export PATH="$PATH:/tmp/apache-ant-1.10.14/bin"' >> .bash_profile;
          echo 'export JAVA_HOME="/tmp/jdk-17.0.5+8"' >> .bash_profile
      - name: Try build
        run: >
          source /tmp/.bash_profile;
          cd build;
          ant clean;
          ant build
      - name: Test
        run: >
          source /tmp/.bash_profile;
          cd build;
          ant test
  linux:
    runs-on: ubuntu-latest
    name: Build Linux
    needs: [test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Update apt
        run: yes | sudo apt-get update
      - name: Install rsync
        run: yes | sudo apt-get install rsync
      - name: Install wget
        run: yes | sudo apt-get install wget
      - name: Install ant
        run: >
          cd /tmp;
          wget https://dlcdn.apache.org//ant/binaries/apache-ant-1.10.14-bin.zip;
          unzip apache-ant-1.10.14-bin.zip
      - name: Install java
        run: >
          cd /tmp;
          wget https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.5%2B8/OpenJDK17U-jdk_x64_linux_hotspot_17.0.5_8.tar.gz;
          tar -xvf OpenJDK17U-jdk_x64_linux_hotspot_17.0.5_8.tar.gz;
      - name: Prepare env
        run: >
          cd /tmp;
          echo 'export ANT_HOME="/tmp/apache-ant-1.10.14"' >> .bash_profile;
          echo 'export PATH="$PATH:/tmp/apache-ant-1.10.14/bin"' >> .bash_profile;
          echo 'export JAVA_HOME="/tmp/jdk-17.0.5+8"' >> .bash_profile
      - name: Build linux
        run: >
          source /tmp/.bash_profile;
          cd build;
          ant clean;
          ant build
      - name: Add artifact
          uses: actions/upload-artifact@v3
          if: {{ github.ref == 'ref/head/main' }}
          with:
            name: linux
            path: ./build/linux/work
  mac:
    runs-on: macos-latest
    name: Build Mac
    needs: [test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install brew
        run: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      - name: Install rsync
        run: brew install rsync
      - name: Install wget
        run: brew install wget
      - name: Install ant
        run: >
          cd /tmp;
          wget https://dlcdn.apache.org//ant/binaries/apache-ant-1.10.14-bin.zip;
          unzip apache-ant-1.10.14-bin.zip
      - name: Install java
        run: >
          cd /tmp;
          wget https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.5%2B8/OpenJDK17U-jdk_x64_mac_hotspot_17.0.5_8.tar.gz;
          tar -xvf OpenJDK17U-jdk_x64_mac_hotspot_17.0.5_8.tar.gz;
      - name: Prepare env
        run: >
          cd /tmp;
          echo 'export ANT_HOME="/tmp/apache-ant-1.10.14"' >> .bash_profile;
          echo 'export PATH="$PATH:/tmp/apache-ant-1.10.14/bin"' >> .bash_profile;
          echo 'export JAVA_HOME="/tmp/jdk-17.0.5+8/Contents/Home"' >> .bash_profile
      - name: Build mac
        run: >
          source /tmp/.bash_profile;
          cd build;
          ant clean;
          ant build
      - name: Add artifact
          uses: actions/upload-artifact@v3
          if: {{ github.ref == 'ref/head/main' }}
          with:
            name: macos
            path: ./build/macos/work
  windows:
    runs-on: windows-latest
    name: Build Windows
    needs: [test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up JDK 11 for x64
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'  
          architecture: x64
      - name: Build
        run: >
          cd build;
          ant clean;
          ant build
      - name: Add artifact
          uses: actions/upload-artifact@v3
          if: {{ github.ref == 'ref/head/main' }}
          with:
            name: windows
            path: ./build/windows/work
